from comanage_nacha.parser import Parser
from comanage_nacha.entries import FileControl, EntryDetail

simple = """101  9100001912737206971506161208A094101WELLSFARGO             COMANAGELLC
5225COMANAGELLC     ACH SETTLEMENT      1234567890CCDPAYMENT         150616   1001237370000001
6271221052785005486880       0000082100               JANE DOE                0001237370000001
822500000100122105270000000821000000000000001234567890                         001237370000001
9000001000001000000010012210527000000082100000000000000
9999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
9999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
9999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
9999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
9999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"""


def test_parse():
    # Just test it doesnt throw exceptions basically
    parser = Parser()
    list(parser.parse(simple))


large = """101  9100001912737206971506161217A094101WELLSFARGO             COMANAGELLC
5200COMANAGELLC     ACH SETTLEMENT      1234567890CCDPAYMENT         150616   1001237370000001
6271221052785005486880       0000082100               JANE DOE                0001237370000001
6271221052786886896684       0000864107               JANE DOE                0001237370000002
6223221747951228713          0000220000               SOME CLEANERS           0001237370000003
622122100024785323353        0000020125               SOME HVAC COMPANY       0001237370000004
820000000400688485350000009462070000002401251234567890                         001237370000001
5220COMANAGELLC     ACH SETTLEMENT      1234567890PPDPAYMENT         150616   1001237370000002
6221221052789886521146       0000101832               HANDYMAN                0001237370000001
6221221052789886521146       0000069863               HANDYMAN                0001237370000002
822000000200244210540000000000000000001716951234567890                         001237370000002
9000002000002000000060093269589000000946207000000411820"""


def test_large():
    # Just test it doesnt throw exceptions basically
    parser = Parser()
    list(parser.parse(large))


confirmation = """101  9100001912737206971506161208A094101WELLSFARGO             COMANAGELLC
5225COMANAGELLC     ACH SETTLEMENT      1234567890CCDPAYMENT         150616   1001237370000001
822500000100122105270000000821000000000000001234567890                         001237370000001
9000001000001000000010012210527000000082100000000000000"""


def test_confirmation():
    parser = Parser(confirmation_file=True)
    (file_header,
     batch_header,
     batch_control,
     file_control) = parser.parse(confirmation)
    assert isinstance(file_control, FileControl)
    assert file_control.message_codes == []


confirmation_message_codes = """101  9100001912737206971506161217A094101WELLSFARGO             COMANAGELLC
5200COMANAGELLC     ACH SETTLEMENT      1234567890CCDPAYMENT         150616   1001237370000001
820000000400688485350000009462070000002401251234567890                         001237370000001
5220COMANAGELLC     ACH SETTLEMENT      1234567890PPDPAYMENT         150616   1001237370000002
822000000200244210540000000000000000001716951234567890                         001237370000002
9000002000002000000060093269589000000946207000000411820 0102TT"""


def test_confirmation_message_codes():
    parser = Parser(confirmation_file=True)
    (file_header,
     batch_header_1,
     batch_control_1,
     batch_header_2,
     batch_control_2,
     file_control) = parser.parse(confirmation_message_codes)
    assert isinstance(file_control, FileControl)
    assert file_control.message_codes == ['01', '02', 'TT']


entry_reject = """101  9100001912737206971506161217A094101WELLSFARGO             COMANAGELLC
5200COMANAGELLC     ACH SETTLEMENT      1234567890CCDPAYMENT         150616   1001237370000001
622122100024785323353        0000020125               SOME HVAC COMPANY       0REJ060010000004
820000000400688485350000009462070000002401251234567890                         001237370000001
9000002000002000000060093269589000000946207000000411820"""


def test_entry_reject():
    parser = Parser(rejection_file=True)
    (file_header,
     batch_header,
     rejected_entry,
     batch_control,
     file_control) = parser.parse(entry_reject)
    assert isinstance(rejected_entry, EntryDetail)
    assert rejected_entry.error_code == '6001'
